<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IP Camera Testing System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #141b2d;
      --bg-tertiary: #1e2740;
      --accent-primary: #00d4ff;
      --accent-secondary: #3b82f6;
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-error: #ef4444;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #334155;
      --pending: #6b7280;
      --shadow: 0 14px 32px rgba(0, 0, 0, 0.35);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 9px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-primary);
      background:
        radial-gradient(circle at 8% 8%, rgba(0, 212, 255, 0.16), transparent 26%),
        radial-gradient(circle at 92% 18%, rgba(16, 185, 129, 0.11), transparent 30%),
        linear-gradient(160deg, #070b17, #0f172a 52%, #121f38);
      padding: 22px;
    }

    .app {
      max-width: 1500px;
      margin: 0 auto;
      display: grid;
      gap: 18px;
      animation: fadeIn 260ms ease;
    }

    .surface {
      background: linear-gradient(170deg, rgba(20, 27, 45, 0.95), rgba(16, 22, 39, 0.97));
      border: 1px solid rgba(71, 85, 105, 0.55);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .header {
      padding: 22px 24px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
    }

    .title {
      margin: 0;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 0.02em;
      font-size: clamp(1.2rem, 2.2vw, 1.8rem);
    }

    .subtitle {
      margin: 8px 0 0;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .progress-badge {
      border: 1px solid rgba(0, 212, 255, 0.4);
      border-radius: 999px;
      padding: 8px 12px;
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent-primary);
      white-space: nowrap;
      font-size: 0.9rem;
      background: rgba(0, 212, 255, 0.1);
    }

    .header-right {
      display: grid;
      gap: 8px;
      justify-items: end;
    }

    .user-badge {
      display: flex;
      gap: 8px;
      align-items: center;
      color: var(--text-secondary);
      font-size: 0.84rem;
    }

    .user-badge strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .auth-gate {
      max-width: 520px;
      margin: 6vh auto 0;
      padding: 18px;
      border: 1px solid rgba(71, 85, 105, 0.55);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      background: linear-gradient(170deg, rgba(20, 27, 45, 0.95), rgba(16, 22, 39, 0.97));
      display: grid;
      gap: 12px;
      animation: fadeIn 240ms ease;
    }

    .auth-title {
      margin: 0;
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.2rem;
      color: var(--accent-primary);
    }

    .auth-subtitle {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .auth-tabs {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .auth-tab {
      flex: 1;
      border: 1px solid rgba(71, 85, 105, 0.75);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      min-height: 38px;
      cursor: pointer;
      font: inherit;
    }

    .auth-tab.active {
      border-color: rgba(0, 212, 255, 0.65);
      color: var(--accent-primary);
      background: rgba(0, 212, 255, 0.1);
    }

    .auth-form {
      display: grid;
      gap: 10px;
      padding: 8px 0 2px;
    }

    .auth-error {
      min-height: 22px;
      color: #fca5a5;
      font-size: 0.85rem;
    }

    .grid-2 {
      padding: 18px;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 18px;
    }

    .panel {
      background: rgba(15, 23, 42, 0.62);
      border: 1px solid rgba(71, 85, 105, 0.5);
      border-radius: var(--radius-md);
      padding: 14px;
    }

    .panel h2 {
      margin: 0 0 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.95rem;
      color: var(--accent-primary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .inputs {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .field { display: grid; gap: 6px; }

    .field label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    input[type='text'],
    input[type='password'],
    input[type='date'],
    textarea,
    .search input {
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: rgba(15, 23, 42, 0.78);
      color: var(--text-primary);
      padding: 10px 12px;
      font: inherit;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }

    input:focus,
    textarea:focus,
    .search input:focus {
      outline: none;
      border-color: rgba(0, 212, 255, 0.75);
      box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .stat {
      border-radius: var(--radius-sm);
      border: 1px solid rgba(71, 85, 105, 0.6);
      background: rgba(2, 6, 23, 0.45);
      padding: 10px;
      min-height: 72px;
      display: grid;
      align-content: center;
      gap: 6px;
    }

    .stat .name {
      font-size: 0.78rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .stat .value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.15rem;
      font-weight: 700;
    }

    .value.passed { color: var(--accent-success); }
    .value.failed { color: var(--accent-error); }
    .value.maybe { color: var(--accent-warning); }
    .value.pending { color: #a7aebc; }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }

    .btn {
      border: 1px solid rgba(71, 85, 105, 0.7);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      cursor: pointer;
      font: inherit;
      min-height: 38px;
      transition: transform 120ms ease, border-color 160ms ease, background 160ms ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      border-color: rgba(0, 212, 255, 0.6);
      background: rgba(30, 41, 59, 0.95);
    }

    .btn.primary {
      background: linear-gradient(160deg, rgba(0, 212, 255, 0.2), rgba(59, 130, 246, 0.16));
      border-color: rgba(0, 212, 255, 0.62);
    }

    .search {
      padding: 0 18px 18px;
    }

    .search input { font-size: 0.95rem; }

    .tree {
      display: grid;
      gap: 12px;
      padding: 0 18px 18px;
    }

    .section {
      border: 1px solid rgba(71, 85, 105, 0.6);
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.66);
      overflow: hidden;
    }

    .section-header {
      width: 100%;
      border: 0;
      background: linear-gradient(160deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.88));
      color: var(--text-primary);
      padding: 12px 14px;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      transition: background 160ms ease;
      min-height: 42px;
    }

    .section-header:hover { background: rgba(30, 41, 59, 0.95); }

    .section-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .section-title {
      font-weight: 700;
      font-size: 0.96rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .section-progress {
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .tests {
      display: grid;
      gap: 10px;
      padding: 12px;
    }

    .test-item {
      border: 1px solid rgba(71, 85, 105, 0.52);
      border-radius: var(--radius-sm);
      background: rgba(2, 6, 23, 0.5);
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .test-top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }

    .test-name {
      margin: 0;
      font-size: 0.98rem;
      line-height: 1.35;
    }

    .test-details {
      margin: 4px 0 0;
      font-size: 0.86rem;
      color: var(--text-secondary);
      line-height: 1.35;
    }

    .status-buttons {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .status-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(71, 85, 105, 0.72);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1rem;
      transition: transform 120ms ease, border-color 160ms ease;
    }

    .status-btn:hover { transform: translateY(-1px); }

    .status-btn.active.passed {
      border-color: rgba(16, 185, 129, 0.9);
      color: var(--accent-success);
      background: rgba(16, 185, 129, 0.12);
    }

    .status-btn.active.failed {
      border-color: rgba(239, 68, 68, 0.95);
      color: var(--accent-error);
      background: rgba(239, 68, 68, 0.12);
    }

    .status-btn.active.maybe {
      border-color: rgba(245, 158, 11, 0.95);
      color: var(--accent-warning);
      background: rgba(245, 158, 11, 0.15);
    }

    .test-bottom {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: start;
    }

    .notes textarea {
      min-height: 80px;
      resize: vertical;
      line-height: 1.35;
    }

    .shots {
      display: grid;
      gap: 8px;
    }

    .uploader {
      border: 1px dashed rgba(71, 85, 105, 0.9);
      border-radius: var(--radius-sm);
      padding: 10px;
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      min-height: 60px;
    }

    .uploader.drag {
      border-color: rgba(0, 212, 255, 0.85);
      background: rgba(0, 212, 255, 0.12);
    }

    .upload-text {
      color: var(--text-secondary);
      font-size: 0.83rem;
    }

    .screens {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .shot {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: rgba(15, 23, 42, 0.8);
      aspect-ratio: 4 / 3;
      border: 1px solid rgba(71, 85, 105, 0.72);
    }

    .shot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: zoom-in;
      display: block;
    }

    .shot-delete {
      position: absolute;
      right: 6px;
      top: 6px;
      width: 24px;
      height: 24px;
      border: 0;
      border-radius: 6px;
      background: rgba(2, 6, 23, 0.86);
      color: #f8fafc;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .shot-delete:hover { background: rgba(239, 68, 68, 0.9); }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.76);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal.show { display: flex; }

    .modal-box {
      width: min(980px, 100%);
      max-height: 90vh;
      overflow: auto;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(71, 85, 105, 0.8);
      background: linear-gradient(170deg, rgba(20, 27, 45, 0.98), rgba(12, 18, 33, 0.98));
      box-shadow: var(--shadow);
      padding: 16px;
      position: relative;
    }

    .modal-close {
      position: absolute;
      right: 10px;
      top: 10px;
      width: 34px;
      height: 34px;
      border: 0;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 1.2rem;
    }

    .modal-close:hover { background: rgba(239, 68, 68, 0.9); }

    .report {
      width: 100%;
      min-height: 400px;
      resize: vertical;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.83rem;
      line-height: 1.35;
      white-space: pre;
    }

    .report-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .image-modal-content img {
      width: 100%;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(71, 85, 105, 0.8);
      display: block;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(20px);
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(71, 85, 105, 0.8);
      color: var(--text-primary);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.86rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 200ms ease, transform 200ms ease;
      z-index: 1100;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .hidden { display: none !important; }

    @media (max-width: 1200px) {
      .grid-2,
      .test-bottom {
        grid-template-columns: 1fr;
      }
    }

    @media (min-width: 1600px) {
      .screens {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    @media (max-width: 768px) {
      body { padding: 12px; }
      .header { padding: 16px; }
      .grid-2,
      .search,
      .tree { padding-left: 12px; padding-right: 12px; }
      .inputs { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .screens { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .test-top { flex-direction: column; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <section class="auth-gate" id="authGate">
    <h2 class="auth-title">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <p class="auth-subtitle">–î–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ –∞–∫–∫–∞—É–Ω—Ç.</p>
    <div class="auth-tabs">
      <button class="auth-tab active" id="loginTab" type="button">–í—Ö–æ–¥</button>
      <button class="auth-tab" id="registerTab" type="button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
    <form class="auth-form" id="authForm">
      <div class="field" id="authNameField">
        <label for="authName">–ò–º—è</label>
        <input id="authName" type="text" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" />
      </div>
      <div class="field">
        <label for="authEmail">Email</label>
        <input id="authEmail" type="text" placeholder="name@example.com" required />
      </div>
      <div class="field">
        <label for="authPassword">–ü–∞—Ä–æ–ª—å</label>
        <input id="authPassword" type="password" placeholder="–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤" required />
      </div>
      <button class="btn primary" id="authSubmitBtn" type="submit">–í–æ–π—Ç–∏</button>
      <div class="auth-error" id="authError"></div>
    </form>
  </section>

  <main class="app hidden" id="appRoot">
    <section class="surface header">
      <div>
        <h1 class="title">IP Camera Testing System</h1>
        <p class="subtitle">–ö–æ–º–∞–Ω–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ IP-–∫–∞–º–µ—Ä —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–æ–∫–∞–ª—å–Ω–æ.</p>
      </div>
      <div class="header-right">
        <div class="user-badge"><span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span> <strong id="userBadge">-</strong></div>
        <button class="btn" id="logoutBtn" type="button" title="–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞">–í—ã–π—Ç–∏</button>
        <div class="progress-badge" id="overallProgress">–ü—Ä–æ–≥—Ä–µ—Å—Å: 0%</div>
      </div>
    </section>

    <section class="surface grid-2">
      <div class="panel">
        <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</h2>
        <div class="inputs">
          <div class="field">
            <label for="projectName">–ü—Ä–æ–µ–∫—Ç</label>
            <input id="projectName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ IPC-HFW5442E-ZE" />
          </div>
          <div class="field">
            <label for="testerName">–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫</label>
            <input id="testerName" type="text" placeholder="–ò–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–∞" />
          </div>
          <div class="field">
            <label for="cameraModel">–ú–æ–¥–µ–ª—å –∫–∞–º–µ—Ä—ã</label>
            <input id="cameraModel" type="text" placeholder="IPC-HFW5442E-ZE" />
          </div>
          <div class="field">
            <label for="firmwareVersion">–í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏</label>
            <input id="firmwareVersion" type="text" placeholder="v2.840.0000000.1.R" />
          </div>
          <div class="field">
            <label for="testDate">–î–∞—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</label>
            <input id="testDate" type="date" />
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="stats-grid">
          <article class="stat"><div class="name">‚úì –ü—Ä–æ–π–¥–µ–Ω–æ</div><div class="value passed" id="statPassed">0</div></article>
          <article class="stat"><div class="name">‚úó –ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ</div><div class="value failed" id="statFailed">0</div></article>
          <article class="stat"><div class="name">? –í–æ–∑–º–æ–∂–Ω–æ</div><div class="value maybe" id="statMaybe">0</div></article>
          <article class="stat"><div class="name">‚óã –û–∂–∏–¥–∞–µ—Ç</div><div class="value pending" id="statPending">0</div></article>
        </div>
        <div class="actions">
          <button class="btn primary" id="exportBtn" title="–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç">üìä –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</button>
          <button class="btn" id="saveBtn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ localStorage">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
          <button class="btn" id="loadBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Å–µ—Å—Å–∏—é">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
          <button class="btn" id="resetBtn" title="–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã, –∑–∞–º–µ—Ç–∫–∏ –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ</button>
        </div>
      </div>
    </section>

    <section class="surface search">
      <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –¥–µ—Ç–∞–ª—è–º –∏–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è–º..." />
    </section>

    <section class="surface tree" id="testTree"></section>
  </main>

  <div class="modal" id="reportModal" aria-hidden="true">
    <div class="modal-box">
      <button class="modal-close" data-close="reportModal" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      <h2 style="margin-top:0;font-family:'JetBrains Mono',monospace;">–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
      <textarea id="reportText" class="report" readonly></textarea>
      <div class="report-actions">
        <button class="btn primary" id="copyReportBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç –≤ –±—É—Ñ–µ—Ä">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn" id="downloadReportBtn" title="–°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç –∫–∞–∫ TXT">–°–∫–∞—á–∞—Ç—å TXT</button>
      </div>
    </div>
  </div>

  <div class="modal" id="imageModal" aria-hidden="true">
    <div class="modal-box image-modal-content">
      <button class="modal-close" data-close="imageModal" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      <img id="fullImage" src="" alt="Screenshot preview" />
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const STORAGE_KEY = 'ipCameraTestData';
    const AUTH_STORAGE_KEY = 'ipCameraAuth';
    const API_BASE = `${window.location.origin}/api`;
    const STATUS = {
      pending: { icon: '‚óã', label: '–û–∂–∏–¥–∞–µ—Ç' },
      passed: { icon: '‚úì', label: '–ü—Ä–æ–π–¥–µ–Ω–æ' },
      failed: { icon: '‚úó', label: '–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ' },
      maybe: { icon: '?', label: '–í–æ–∑–º–æ–∂–Ω–æ' }
    };

    const testData = [
      {
        id: 'base-settings',
        name: '–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
        icon: 'üîß',
        tests: [
          { id: 'base-device-name', name: '–ò–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.' },
          { id: 'base-af-lens', name: '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–∏–≤–∞ AF LENS', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–∫–∞–ª–∏–±—Ä–æ–≤–∫—É —Ñ–æ–∫—É—Å–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.' },
          { id: 'base-mobile-p2p', name: 'Mobile P2P', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã –≤ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å P2P.' }
        ]
      },
      {
        id: 'system',
        name: '–°–∏—Å—Ç–µ–º–∞ (System)',
        icon: 'üñ•Ô∏è',
        tests: [
          { id: 'sys-date-time', name: '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä—É—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏.' },
          { id: 'sys-ntp', name: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å NTP', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å NTP-—Å–µ—Ä–≤–µ—Ä–æ–º.' },
          { id: 'sys-dst', name: '–õ–µ—Ç–Ω–µ–µ –≤—Ä–µ–º—è', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ DST.' },
          { id: 'sys-auto-reboot', name: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.' },
          { id: 'sys-maintenance', name: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–∏—Å—Ç–∫—É/—Å–µ—Ä–≤–∏—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.' },
          { id: 'sys-config-impex', name: '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç)', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.' },
          { id: 'sys-fw-update', name: '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–∫.' },
          { id: 'sys-ptz-rs485', name: 'PTZ/RS485', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ RS485 –∏ —Å–≤—è–∑–∏ —Å PTZ.' },
          { id: 'sys-alarm-if', name: '–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç—Ä–µ–≤–æ–≥', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ —Ç—Ä–µ–≤–æ–∂–Ω—ã–µ –≤—Ö–æ–¥—ã/–≤—ã—Ö–æ–¥—ã.' },
          { id: 'sys-info', name: '–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.' },
          { id: 'sys-logs', name: '–õ–æ–≥–∏', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–∏—Å—å –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–æ–≤ —Å–æ–±—ã—Ç–∏–π.' }
        ]
      },
      {
        id: 'network',
        name: '–°–µ—Ç—å (Network)',
        icon: 'üåê',
        tests: [
          { id: 'net-tcpip', name: 'TCP/IP', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å DHCP/—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–∞–º–µ—Ä—ã.' },
          { id: 'net-dns', name: 'DNS', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–æ–ª–≤–∏–Ω–≥–∞ –¥–æ–º–µ–Ω–Ω—ã—Ö –∏–º—ë–Ω.' },
          { id: 'net-ports', name: '–ü–æ—Ä—Ç—ã', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è HTTP/HTTPS/RTSP –ø–æ—Ä—Ç–æ–≤.' },
          { id: 'net-wifi', name: 'WiFi', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WiFi-—Å–µ—Ç–∏ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏.' },
          { id: 'net-pppoe', name: 'PPPoE', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ PPPoE-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.' },
          { id: 'net-smtp', name: 'SMTP', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.' },
          { id: 'net-upnp', name: 'UPnP', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Ä—Ç–æ–≤ —á–µ—Ä–µ–∑ UPnP.' },
          { id: 'net-ddns', name: 'DDNS', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DDNS-–∑–∞–ø–∏—Å–µ–π.' },
          { id: 'net-rtsp', name: 'RTSP', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å RTSP-–ø–æ—Ç–æ–∫–∞.' },
          { id: 'net-rtmp', name: 'RTMP', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ RTMP.' },
          { id: 'net-sip', name: 'VoIP/SIP', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SIP-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –≤—ã–∑–æ–≤—ã.' },
          { id: 'net-snmp', name: 'SNMP', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ SNMP-–º–µ—Ç—Ä–∏–∫ –∏ –¥–æ—Å—Ç—É–ø–∞.' },
          { id: 'net-8021x', name: 'IEEE 802.1x', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.' },
          { id: 'net-bonjour', name: 'Bonjour', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Å–µ—Ç–∏.' },
          { id: 'net-gb28181', name: 'GB28181', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ–¥–∞—á–∏ –≤ GB28181.' },
          { id: 'net-qos', name: 'QoS', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞.' },
          { id: 'net-https', name: 'HTTPS', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.' }
        ]
      },
      {
        id: 'video',
        name: '–í–∏–¥–µ–æ (Video)',
        icon: 'üé•',
        tests: [
          { id: 'vid-stream-main', name: '–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ: –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∏—Ç—Ä–µ–π—Ç, FPS, –∫–æ–¥–µ–∫, GOP.' },
          { id: 'vid-stream-sub', name: '–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø–æ–¥–ø–æ—Ç–æ–∫', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–æ—Ç–æ–∫–∞.' },
          { id: 'vid-stream-third', name: '–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ç—Ä–µ—Ç–∏–π –ø–æ—Ç–æ–∫', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—Ä–µ—Ç—å–µ–≥–æ –ø–æ—Ç–æ–∫–∞.' },
          { id: 'vid-roi', name: 'ROI', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–ª–∞—Å—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∏ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ.' },
          { id: 'vid-osd', name: 'OSD', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç—ã/—Ç–µ–∫—Å—Ç–∞ –≤ OSD.' },
          { id: 'vid-privacy-mask', name: '–ú–∞—Å–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞—Å–æ–∫.' },
          { id: 'vid-image', name: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', details: '–Ø—Ä–∫–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–∞—Å—Ç, –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å, —Ä–µ–∑–∫–æ—Å—Ç—å.' },
          { id: 'vid-exposure', name: '–≠–∫—Å–ø–æ–∑–∏—Ü–∏—è', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–æ–≤ —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏.' },
          { id: 'vid-white-balance', name: '–ë–∞–ª–∞–Ω—Å –±–µ–ª–æ–≥–æ', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ü–≤–µ—Ç–æ–ø–µ—Ä–µ–¥–∞—á–∏.' },
          { id: 'vid-day-night', name: '–î–µ–Ω—å/–ù–æ—á—å', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤.' },
          { id: 'vid-ir', name: '–ò–ö –ø–æ–¥—Å–≤–µ—Ç–∫–∞', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ò–ö-–ø–æ–¥—Å–≤–µ—Ç–∫–∏.' },
          { id: 'vid-defog', name: '–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ç—É–º–∞–Ω–∞', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ Defog.' },
          { id: 'vid-wdr', name: 'WDR', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Wide Dynamic Range.' },
          { id: 'vid-blc', name: 'BLC', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –∑–∞–¥–Ω–µ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏.' },
          { id: 'vid-hlc', name: 'HLC', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –∑–∞—Å–≤–µ—Ç–∫–∏.' },
          { id: 'vid-mirror-flip', name: '–ó–µ—Ä–∫–∞–ª–æ –∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.' },
          { id: 'vid-corridor', name: '–†–µ–∂–∏–º –∫–æ—Ä–∏–¥–æ—Ä–∞', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä–∏–¥–æ—Ä–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.' }
        ]
      },
      {
        id: 'audio',
        name: '–ê—É–¥–∏–æ (Audio)',
        icon: 'üîä',
        tests: [
          { id: 'aud-encoding', name: '–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—É–¥–∏–æ–∫–æ–¥–µ–∫ –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∑–≤—É–∫–∞.' },
          { id: 'aud-io', name: '–í—Ö–æ–¥—ã/–≤—ã—Ö–æ–¥—ã', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É–¥–∏–æ–≤—Ö–æ–¥–∞ –∏ –∞—É–¥–∏–æ–≤—ã—Ö–æ–¥–∞.' },
          { id: 'aud-denoise', name: '–®—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è —à—É–º–∞.' },
          { id: 'aud-detection', name: '–î–µ—Ç–µ–∫—Ü–∏—è –∑–≤—É–∫–∞', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–µ–≤–æ–≥—É –ø—Ä–∏ –∑–≤—É–∫–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö.' }
        ]
      },
      {
        id: 'storage',
        name: '–•—Ä–∞–Ω–µ–Ω–∏–µ (Storage)',
        icon: 'üíæ',
        tests: [
          { id: 'sto-schedule', name: '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π/—Å–æ–±—ã—Ç–∏–π–Ω–æ–π –∑–∞–ø–∏—Å–∏.' },
          { id: 'sto-sd', name: 'SD –∫–∞—Ä—Ç–∞', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ SD.' },
          { id: 'sto-nas', name: 'NAS', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ NAS –∏ –∑–∞–ø–∏—Å–∏.' },
          { id: 'sto-ftp', name: 'FTP', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –Ω–∞ FTP.' },
          { id: 'sto-cloud', name: '–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.' },
          { id: 'sto-overwrite', name: '–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.' }
        ]
      },
      {
        id: 'events',
        name: '–°–æ–±—ã—Ç–∏—è (Events)',
        icon: 'üö®',
        tests: [
          { id: 'evt-motion', name: '–î–µ—Ç–µ–∫—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–æ–Ω—ã, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∞–∫—Ü–∏–∏.' },
          { id: 'evt-tamper', name: '–°–∞–±–æ—Ç–∞–∂', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –∫–∞–º–µ—Ä—ã.' },
          { id: 'evt-scene', name: '–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–≤–æ–≥–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ü–µ–Ω—ã.' },
          { id: 'evt-alarm-io', name: '–¢—Ä–µ–≤–æ–∂–Ω—ã–µ –≤—Ö–æ–¥—ã/–≤—ã—Ö–æ–¥—ã', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã I/O —Ç—Ä–µ–≤–æ–≥.' },
          { id: 'evt-anomaly', name: '–ê–Ω–æ–º–∞–ª–∏–∏', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–≤–æ–≥ –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö/—Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∞–Ω–æ–º–∞–ª–∏—è—Ö.' },
          { id: 'evt-actions', name: '–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö', details: '–ü–æ—á—Ç–∞, –∑–∞–ø–∏—Å—å, PTZ-—Ä–µ–∞–∫—Ü–∏—è, —Ç—Ä–µ–≤–æ–∂–Ω—ã–π –≤—ã—Ö–æ–¥.' }
        ]
      },
      {
        id: 'smart',
        name: '–í–∏–¥–µ–æ–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (Smart Analysis)',
        icon: 'üß†',
        tests: [
          { id: 'sm-face', name: '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ª–∏—Ü', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ –ª–∏—Ü –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞.' },
          { id: 'sm-human', name: '–î–µ—Ç–µ–∫—Ç–æ—Ä –ª—é–¥–µ–π', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ–ª–æ–≤–µ–∫–∞.' },
          { id: 'sm-vehicle', name: '–î–µ—Ç–µ–∫—Ç–æ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤.' },
          { id: 'sm-line-cross', name: '–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ª–∏–Ω–∏–π', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã crossing line.' },
          { id: 'sm-intrusion', name: '–í—Ç–æ—Ä–∂–µ–Ω–∏–µ', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å intrusion detection.' },
          { id: 'sm-loitering', name: 'Loitering', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–µ–≤–æ–≥—É –ø—Ä–∏ –∑–∞–¥–µ—Ä–∂–∫–µ –≤ –∑–æ–Ω–µ.' },
          { id: 'sm-object', name: '–û—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ/–ø—Ä–æ–ø–∞–≤—à–∏–µ –æ–±—ä–µ–∫—Ç—ã', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å abandoned/missing object.' },
          { id: 'sm-crowd', name: '–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ç–æ–ª–ø—ã', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥—Å—á—ë—Ç–∞ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏/–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è.' }
        ]
      },
      {
        id: 'security',
        name: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (Security)',
        icon: 'üîê',
        tests: [
          { id: 'sec-users', name: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏', details: '–°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.' },
          { id: 'sec-groups', name: '–ì—Ä—É–ø–ø—ã –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–µ –ø—Ä–∞–≤–∞.' },
          { id: 'sec-ip-filter', name: 'IP —Ñ–∏–ª—å—Ç—Ä', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ whitelist/blacklist.' },
          { id: 'sec-policy', name: '–ü–æ–ª–∏—Ç–∏–∫–∞ –ø–∞—Ä–æ–ª–µ–π', details: '–°–ª–æ–∂–Ω–æ—Å—Ç—å –∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø–∞—Ä–æ–ª–µ–π.' },
          { id: 'sec-https', name: 'HTTPS', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ TLS-–¥–æ—Å—Ç—É–ø–∞ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.' },
          { id: 'sec-telnet-ssh', name: 'Telnet/SSH', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.' }
        ]
      },
      {
        id: 'ptz',
        name: 'PTZ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
        icon: 'üéõÔ∏è',
        tests: [
          { id: 'ptz-dir', name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–æ—Ä–æ—Ç/–Ω–∞–∫–ª–æ–Ω –∫–∞–º–µ—Ä—ã.' },
          { id: 'ptz-zoom', name: '–ó—É–º', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å zoom in/zoom out.' },
          { id: 'ptz-focus', name: '–§–æ–∫—É—Å', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ –∏ —Ä—É—á–Ω–æ–π —Ñ–æ–∫—É—Å.' },
          { id: 'ptz-iris', name: '–î–∏–∞—Ñ—Ä–∞–≥–º–∞', details: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ iris.' },
          { id: 'ptz-presets', name: '–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –≤—ã–∑–æ–≤–∞ –ø—Ä–µ—Å–µ—Ç–æ–≤.' },
          { id: 'ptz-tours', name: '–¢—É—Ä—ã', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –æ–±—Ö–æ–¥–∞.' },
          { id: 'ptz-patterns', name: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∏ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.' },
          { id: 'ptz-autoscan', name: '–ê–≤—Ç–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ –∞–≤—Ç–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.' },
          { id: 'ptz-home', name: '–î–æ–º–∞—à–Ω—è—è –ø–æ–∑–∏—Ü–∏—è', details: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ home –ø–æ–∑–∏—Ü–∏—é.' }
        ]
      }
    ];

    const state = {
      testStates: {},
      testNotes: {},
      testScreenshots: {},
      sectionCollapsed: {},
      projectName: '',
      cameraModel: '',
      firmwareVersion: '',
      testerName: '',
      testDate: '',
      savedAt: '',
      searchQuery: '',
      authMode: 'login',
      auth: {
        token: '',
        user: null
      }
    };

    const els = {
      appRoot: document.getElementById('appRoot'),
      authGate: document.getElementById('authGate'),
      loginTab: document.getElementById('loginTab'),
      registerTab: document.getElementById('registerTab'),
      authForm: document.getElementById('authForm'),
      authNameField: document.getElementById('authNameField'),
      authName: document.getElementById('authName'),
      authEmail: document.getElementById('authEmail'),
      authPassword: document.getElementById('authPassword'),
      authSubmitBtn: document.getElementById('authSubmitBtn'),
      authError: document.getElementById('authError'),
      userBadge: document.getElementById('userBadge'),
      logoutBtn: document.getElementById('logoutBtn'),
      projectName: document.getElementById('projectName'),
      cameraModel: document.getElementById('cameraModel'),
      firmwareVersion: document.getElementById('firmwareVersion'),
      testerName: document.getElementById('testerName'),
      testDate: document.getElementById('testDate'),
      searchInput: document.getElementById('searchInput'),
      testTree: document.getElementById('testTree'),
      overallProgress: document.getElementById('overallProgress'),
      statPassed: document.getElementById('statPassed'),
      statFailed: document.getElementById('statFailed'),
      statMaybe: document.getElementById('statMaybe'),
      statPending: document.getElementById('statPending'),
      exportBtn: document.getElementById('exportBtn'),
      saveBtn: document.getElementById('saveBtn'),
      loadBtn: document.getElementById('loadBtn'),
      resetBtn: document.getElementById('resetBtn'),
      reportModal: document.getElementById('reportModal'),
      imageModal: document.getElementById('imageModal'),
      reportText: document.getElementById('reportText'),
      copyReportBtn: document.getElementById('copyReportBtn'),
      downloadReportBtn: document.getElementById('downloadReportBtn'),
      fullImage: document.getElementById('fullImage'),
      toast: document.getElementById('toast')
    };

    async function init() {
      const today = new Date().toISOString().slice(0, 10);
      state.testDate = today;
      els.testDate.value = today;
      bindGlobalEvents();
      setAuthMode('login');

      const auth = loadAuthFromStorage();
      if (auth) {
        state.auth = auth;
        const ok = await restoreSession();
        if (ok) {
          onAuthenticated();
          return;
        }
      }

      showAuthGate();
    }

    function bindGlobalEvents() {
      els.loginTab.addEventListener('click', () => setAuthMode('login'));
      els.registerTab.addEventListener('click', () => setAuthMode('register'));
      els.authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await submitAuth();
      });
      els.logoutBtn.addEventListener('click', logout);

      [
        ['projectName', 'projectName'],
        ['cameraModel', 'cameraModel'],
        ['firmwareVersion', 'firmwareVersion'],
        ['testerName', 'testerName'],
        ['testDate', 'testDate']
      ].forEach(([elKey, stateKey]) => {
        els[elKey].addEventListener('input', (e) => {
          state[stateKey] = e.target.value;
          saveToLocalStorage();
        });
      });

      els.searchInput.addEventListener('input', (e) => {
        state.searchQuery = e.target.value.trim().toLowerCase();
        renderTree();
      });

      els.exportBtn.addEventListener('click', () => {
        els.reportText.value = generateReport();
        openModal(els.reportModal);
      });

      els.saveBtn.addEventListener('click', () => {
        saveToLocalStorage();
        showToast('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω.');
      });

      els.loadBtn.addEventListener('click', () => {
        loadFromLocalStorage(false);
      });

      els.resetBtn.addEventListener('click', () => {
        const ok = window.confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã, –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã?');
        if (!ok) return;
        state.testStates = {};
        state.testNotes = {};
        state.testScreenshots = {};
        saveToLocalStorage();
        render();
        showToast('–î–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤ –æ—á–∏—â–µ–Ω—ã.');
      });

      els.copyReportBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(els.reportText.value);
          showToast('–û—Ç—á—ë—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.');
        } catch {
          showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç.');
        }
      });

      els.downloadReportBtn.addEventListener('click', () => {
        const model = sanitizeFilePart(state.cameraModel || 'camera');
        const date = sanitizeFilePart(state.testDate || new Date().toISOString().slice(0, 10));
        const fileName = `test_report_${model}_${date}.txt`;
        const blob = new Blob([els.reportText.value], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
        URL.revokeObjectURL(link.href);
      });

      document.querySelectorAll('[data-close]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-close');
          closeModal(document.getElementById(id));
        });
      });

      [els.reportModal, els.imageModal].forEach((modal) => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal(modal);
        });
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal(els.reportModal);
          closeModal(els.imageModal);
        }
      });
    }

    function setAuthMode(mode) {
      state.authMode = mode;
      const isRegister = mode === 'register';
      els.loginTab.classList.toggle('active', !isRegister);
      els.registerTab.classList.toggle('active', isRegister);
      els.authNameField.classList.toggle('hidden', !isRegister);
      els.authSubmitBtn.textContent = isRegister ? '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç' : '–í–æ–π—Ç–∏';
      els.authError.textContent = '';
    }

    async function submitAuth() {
      const name = els.authName.value.trim();
      const email = els.authEmail.value.trim().toLowerCase();
      const password = els.authPassword.value;
      const isRegister = state.authMode === 'register';

      if (isRegister && name.length < 2) {
        els.authError.textContent = '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 2 —Å–∏–º–≤–æ–ª–æ–≤.';
        return;
      }
      if (!email.includes('@')) {
        els.authError.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email.';
        return;
      }
      if (password.length < 8) {
        els.authError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 8 —Å–∏–º–≤–æ–ª–æ–≤.';
        return;
      }

      els.authSubmitBtn.disabled = true;
      els.authError.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';

      try {
        const endpoint = isRegister ? '/auth/register' : '/auth/login';
        const body = isRegister ? { name, email, password } : { email, password };
        const response = await fetch(`${API_BASE}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const payload = await response.json();

        if (!response.ok) {
          throw new Error(payload.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.');
        }

        state.auth = { token: payload.token, user: payload.user };
        saveAuthToStorage();
        els.authPassword.value = '';
        onAuthenticated();
        showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω.');
      } catch (error) {
        els.authError.textContent = error.message || '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.';
      } finally {
        els.authSubmitBtn.disabled = false;
        if (els.authError.textContent === '–ü—Ä–æ–≤–µ—Ä–∫–∞...') els.authError.textContent = '';
      }
    }

    async function restoreSession() {
      try {
        const response = await fetch(`${API_BASE}/auth/me`, {
          headers: { Authorization: `Bearer ${state.auth.token}` }
        });
        const payload = await response.json();
        if (!response.ok) return false;
        state.auth.user = payload.user;
        saveAuthToStorage();
        return true;
      } catch {
        return false;
      }
    }

    function onAuthenticated() {
      resetSessionState();
      showApp();
      loadFromLocalStorage(true);
      render();
    }

    function showAuthGate() {
      els.authGate.classList.remove('hidden');
      els.appRoot.classList.add('hidden');
    }

    function showApp() {
      els.authGate.classList.add('hidden');
      els.appRoot.classList.remove('hidden');
    }

    function updateUserBadge() {
      els.userBadge.textContent = state.auth.user?.email || '-';
    }

    function loadAuthFromStorage() {
      try {
        const raw = localStorage.getItem(AUTH_STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed?.token || !parsed?.user?.id) return null;
        return parsed;
      } catch {
        return null;
      }
    }

    function saveAuthToStorage() {
      localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(state.auth));
    }

    function clearAuthStorage() {
      localStorage.removeItem(AUTH_STORAGE_KEY);
    }

    function logout() {
      state.auth = { token: '', user: null };
      clearAuthStorage();
      resetSessionState();
      els.authPassword.value = '';
      showAuthGate();
      showToast('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.');
    }

    function resetSessionState() {
      state.testStates = {};
      state.testNotes = {};
      state.testScreenshots = {};
      state.sectionCollapsed = {};
      state.projectName = '';
      state.cameraModel = '';
      state.firmwareVersion = '';
      state.testerName = '';
      state.testDate = new Date().toISOString().slice(0, 10);
      state.savedAt = '';
      state.searchQuery = '';
      els.searchInput.value = '';
    }

    function render() {
      fillHeaderInputs();
      updateUserBadge();
      renderTree();
      updateStats();
    }

    function fillHeaderInputs() {
      els.projectName.value = state.projectName || '';
      els.cameraModel.value = state.cameraModel || '';
      els.firmwareVersion.value = state.firmwareVersion || '';
      els.testerName.value = state.testerName || '';
      els.testDate.value = state.testDate || new Date().toISOString().slice(0, 10);
    }

    function renderTree() {
      const query = state.searchQuery;
      const html = [];

      for (const section of testData) {
        const tests = section.tests.filter((test) => matchesSearch(test, query));
        if (query && tests.length === 0) continue;

        const collapsed = !!state.sectionCollapsed[section.id] && !query;
        const done = tests.filter((t) => getStatus(t.id) !== 'pending').length;

        html.push(`
          <article class="section">
            <button class="section-header" data-section-toggle="${section.id}" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ä–∞–∑–¥–µ–ª">
              <span class="section-left">
                <span>${section.icon}</span>
                <span class="section-title">${escapeHtml(section.name)}</span>
              </span>
              <span class="section-progress">${done}/${tests.length}</span>
            </button>
            <div class="tests ${collapsed ? 'hidden' : ''}" id="section-${section.id}">
              ${tests.map((test) => renderTestItem(test)).join('')}
            </div>
          </article>
        `);
      }

      els.testTree.innerHTML = html.join('') || '<div class="panel">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ —Ç–µ–∫—É—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É.</div>';

      els.testTree.querySelectorAll('[data-section-toggle]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-section-toggle');
          state.sectionCollapsed[id] = !state.sectionCollapsed[id];
          renderTree();
          saveToLocalStorage();
        });
      });

      bindTreeEvents();
    }

    function renderTestItem(test) {
      const status = getStatus(test.id);
      const note = state.testNotes[test.id] || '';
      const screenshots = state.testScreenshots[test.id] || [];

      const statusBtn = (type, symbol, title) => `
        <button
          class="status-btn ${status === type ? `active ${type}` : ''}"
          data-status-btn="${test.id}:${type}"
          title="${title}"
          aria-label="${title}"
        >${symbol}</button>
      `;

      return `
        <div class="test-item" data-test-id="${test.id}">
          <div class="test-top">
            <div>
              <h3 class="test-name">${escapeHtml(test.name)}</h3>
              <p class="test-details">${escapeHtml(test.details)}</p>
            </div>
            <div class="status-buttons">
              ${statusBtn('passed', '‚úì', '–ü—Ä–æ–π–¥–µ–Ω–æ')}
              ${statusBtn('failed', '‚úó', '–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ')}
              ${statusBtn('maybe', '?', '–í–æ–∑–º–æ–∂–Ω–æ')}
            </div>
          </div>

          <div class="test-bottom">
            <div class="notes">
              <textarea
                data-note-input="${test.id}"
                placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã..."
              >${escapeHtml(note)}</textarea>
            </div>

            <div class="shots">
              <div class="uploader" data-drop-zone="${test.id}">
                <span class="upload-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ JPG/PNG/GIF —Å—é–¥–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Ä—É—á–Ω—É—é</span>
                <button class="btn" data-upload-btn="${test.id}" type="button" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</button>
                <input class="hidden" data-upload-input="${test.id}" type="file" accept="image/png,image/jpeg,image/gif" multiple />
              </div>
              <div class="screens">${renderScreenshots(test.id, screenshots)}</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderScreenshots(testId, screenshots) {
      if (!screenshots.length) {
        return '<div class="upload-text">–°–∫—Ä–∏–Ω—à–æ—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
      }

      return screenshots
        .map((src, idx) => `
          <div class="shot">
            <img src="${src}" alt="–°–∫—Ä–∏–Ω—à–æ—Ç ${idx + 1}" data-open-image="${testId}:${idx}" />
            <button class="shot-delete" type="button" data-delete-image="${testId}:${idx}" title="–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">√ó</button>
          </div>
        `)
        .join('');
    }

    function bindTreeEvents() {
      els.testTree.querySelectorAll('[data-status-btn]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const [testId, status] = btn.getAttribute('data-status-btn').split(':');
          setStatus(testId, status);
        });
      });

      els.testTree.querySelectorAll('[data-note-input]').forEach((textarea) => {
        autoResize(textarea);
        textarea.addEventListener('input', (e) => {
          const testId = e.target.getAttribute('data-note-input');
          state.testNotes[testId] = e.target.value;
          autoResize(e.target);
          saveToLocalStorage();
          updateStats();
        });
      });

      els.testTree.querySelectorAll('[data-upload-btn]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const testId = btn.getAttribute('data-upload-btn');
          const input = els.testTree.querySelector(`[data-upload-input="${testId}"]`);
          input?.click();
        });
      });

      els.testTree.querySelectorAll('[data-upload-input]').forEach((input) => {
        input.addEventListener('change', async (e) => {
          const testId = e.target.getAttribute('data-upload-input');
          await addScreenshots(testId, Array.from(e.target.files || []));
          e.target.value = '';
        });
      });

      els.testTree.querySelectorAll('[data-drop-zone]').forEach((zone) => {
        zone.addEventListener('dragover', (e) => {
          e.preventDefault();
          zone.classList.add('drag');
        });
        zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
        zone.addEventListener('drop', async (e) => {
          e.preventDefault();
          zone.classList.remove('drag');
          const testId = zone.getAttribute('data-drop-zone');
          await addScreenshots(testId, Array.from(e.dataTransfer?.files || []));
        });
      });

      els.testTree.querySelectorAll('[data-open-image]').forEach((img) => {
        img.addEventListener('click', () => {
          const [testId, idxRaw] = img.getAttribute('data-open-image').split(':');
          const idx = Number(idxRaw);
          els.fullImage.src = state.testScreenshots[testId][idx];
          openModal(els.imageModal);
        });
      });

      els.testTree.querySelectorAll('[data-delete-image]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const [testId, idxRaw] = btn.getAttribute('data-delete-image').split(':');
          const idx = Number(idxRaw);
          state.testScreenshots[testId].splice(idx, 1);
          if (state.testScreenshots[testId].length === 0) delete state.testScreenshots[testId];
          saveToLocalStorage();
          renderTree();
          updateStats();
        });
      });
    }

    function setStatus(testId, nextStatus) {
      const current = getStatus(testId);
      state.testStates[testId] = current === nextStatus ? 'pending' : nextStatus;
      saveToLocalStorage();
      renderTree();
      updateStats();
    }

    function getStatus(testId) {
      return state.testStates[testId] || 'pending';
    }

    async function addScreenshots(testId, files) {
      if (!files.length) return;
      const valid = files.filter((f) => /^image\/(png|jpeg|gif)$/.test(f.type));
      if (!valid.length) {
        showToast('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ JPG, PNG –∏ GIF.');
        return;
      }

      try {
        const encoded = await Promise.all(valid.map(fileToBase64));
        const current = state.testScreenshots[testId] || [];
        state.testScreenshots[testId] = [...current, ...encoded];
        saveToLocalStorage();
        renderTree();
        updateStats();
      } catch {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞.');
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function updateStats() {
      const allTests = testData.flatMap((section) => section.tests);
      let passed = 0;
      let failed = 0;
      let maybe = 0;

      for (const test of allTests) {
        const st = getStatus(test.id);
        if (st === 'passed') passed++;
        else if (st === 'failed') failed++;
        else if (st === 'maybe') maybe++;
      }

      const total = allTests.length;
      const pending = total - passed - failed - maybe;
      const done = total - pending;
      const progress = total ? Math.round((done / total) * 100) : 0;

      els.statPassed.textContent = String(passed);
      els.statFailed.textContent = String(failed);
      els.statMaybe.textContent = String(maybe);
      els.statPending.textContent = String(pending);
      els.overallProgress.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}% (${done}/${total})`;
    }

    function generateReport() {
      const allTests = testData.flatMap((section) => section.tests);
      const passed = allTests.filter((t) => getStatus(t.id) === 'passed').length;
      const failed = allTests.filter((t) => getStatus(t.id) === 'failed').length;
      const maybe = allTests.filter((t) => getStatus(t.id) === 'maybe').length;
      const pending = allTests.length - passed - failed - maybe;
      const progress = allTests.length ? Math.round(((passed + failed + maybe) / allTests.length) * 100) : 0;

      const lines = [
        '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó',
        '‚ïë        –û–¢–ß–Å–¢ –û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ò IP-–ö–ê–ú–ï–†–´                        ‚ïë',
        '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù',
        '',
        'üìã –û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø',
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
        `–ü—Ä–æ–µ–∫—Ç:            ${state.projectName || '-'}`,
        `–ú–æ–¥–µ–ª—å –∫–∞–º–µ—Ä—ã:     ${state.cameraModel || '-'}`,
        `–í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏:   ${state.firmwareVersion || '-'}`,
        `–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫:       ${state.testerName || '-'}`,
        `–î–∞—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${state.testDate || '-'}`,
        '',
        'üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê',
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
        `‚úì –ü—Ä–æ–π–¥–µ–Ω–æ:        ${passed}`,
        `‚úó –ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ:     ${failed}`,
        `? –í–æ–∑–º–æ–∂–Ω–æ:        ${maybe}`,
        `‚óã –û–∂–∏–¥–∞–µ—Ç:         ${pending}`,
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
        `–í–°–ï–ì–û –¢–ï–°–¢–û–í:      ${allTests.length}`,
        `–ü—Ä–æ–≥—Ä–µ—Å—Å:          ${progress}%`,
        '',
        'üìù –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø',
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ'
      ];

      for (const section of testData) {
        lines.push('');
        lines.push(`${section.icon} ${section.name}`);
        lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

        for (const test of section.tests) {
          const status = getStatus(test.id);
          const note = (state.testNotes[test.id] || '').trim() || '-';
          const shots = (state.testScreenshots[test.id] || []).length;
          const padded = STATUS[status].label.toUpperCase().padEnd(12, ' ');

          lines.push(`${STATUS[status].icon} [${padded}] ${test.name}`);
          lines.push(`   ${test.details}`);
          lines.push(`   üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è: ${note}`);
          lines.push(`   üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ: ${shots}`);
        }
      }

      lines.push('');
      lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      lines.push(`–û—Ç—á—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${new Date().toLocaleString('ru-RU')}`);
      lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

      return lines.join('\n');
    }

    function loadFromLocalStorage(silent) {
      const storageKey = getStorageKey();
      if (!storageKey) return;
      try {
        const raw = localStorage.getItem(storageKey);
        if (!raw) {
          if (!silent) showToast('–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
          return;
        }

        const parsed = JSON.parse(raw);
        state.testStates = parsed.testStates || {};
        state.testNotes = parsed.testNotes || {};
        state.testScreenshots = parsed.testScreenshots || {};
        state.projectName = parsed.projectName || '';
        state.cameraModel = parsed.cameraModel || '';
        state.firmwareVersion = parsed.firmwareVersion || '';
        state.testerName = parsed.testerName || '';
        state.testDate = parsed.testDate || state.testDate;
        state.savedAt = parsed.savedAt || '';
        state.sectionCollapsed = parsed.sectionCollapsed || {};

        if (!silent) {
          showToast(`–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω${state.savedAt ? ` (${new Date(state.savedAt).toLocaleString('ru-RU')})` : ''}.`);
          render();
        }
      } catch {
        showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage.');
      }
    }

    function saveToLocalStorage() {
      const storageKey = getStorageKey();
      if (!storageKey) return;
      try {
        const payload = {
          testStates: state.testStates,
          testNotes: state.testNotes,
          testScreenshots: state.testScreenshots,
          sectionCollapsed: state.sectionCollapsed,
          projectName: state.projectName,
          cameraModel: state.cameraModel,
          firmwareVersion: state.firmwareVersion,
          testerName: state.testerName,
          testDate: state.testDate,
          savedAt: new Date().toISOString()
        };
        state.savedAt = payload.savedAt;
        localStorage.setItem(storageKey, JSON.stringify(payload));
      } catch {
        showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –í–æ–∑–º–æ–∂–Ω–æ, –ª–∏–º–∏—Ç localStorage –ø—Ä–µ–≤—ã—à–µ–Ω.');
      }
    }

    function getStorageKey() {
      const userId = state.auth.user?.id;
      return userId ? `${STORAGE_KEY}:${userId}` : '';
    }

    function matchesSearch(test, query) {
      if (!query) return true;
      const haystack = [
        test.name,
        test.details,
        state.testNotes[test.id] || ''
      ].join(' ').toLowerCase();
      return haystack.includes(query);
    }

    function escapeHtml(value) {
      return String(value)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function sanitizeFilePart(value) {
      return String(value)
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9._-]+/g, '_')
        .replace(/^_+|_+$/g, '') || 'report';
    }

    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = `${Math.max(textarea.scrollHeight, 80)}px`;
    }

    function openModal(modal) {
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeModal(modal) {
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      if (modal === els.imageModal) els.fullImage.src = '';
    }

    let toastTimer;
    function showToast(message) {
      els.toast.textContent = message;
      els.toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => els.toast.classList.remove('show'), 2200);
    }

    document.addEventListener('DOMContentLoaded', () => {
      init().catch(() => {
        showAuthGate();
        showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
      });
    });
  </script>
</body>
</html>
